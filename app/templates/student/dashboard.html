{% extends "base.html" %}
{% block title %}Кабинет ученика{% endblock %}
{% block content %}
<h1>Кабинет ученика</h1>
<div class="grid grid-2">
  <div class="card">
    <h3>Пищевые аллергии и предпочтения</h3>
    <form method="post" action="{{ url_for('routes.student_profile') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <label>Аллергии</label>
      <textarea name="allergies" rows="2" maxlength="500" placeholder="Например: орехи, молочные продукты">{{ student['allergies'] }}</textarea>
      <label>Пищевые предпочтения</label>
      <textarea name="preferences" rows="2" maxlength="500" placeholder="Например: без сахара, больше овощей">{{ student['preferences'] }}</textarea>
      <button type="submit">Сохранить профиль питания</button>
    </form>
  </div>

  <div class="card">
    <h3>Меню и отметка получения питания</h3>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Дата</th><th>Тип</th><th>Блюдо</th><th>Цена</th><th>Остаток</th><th>Действие</th></tr>
        </thead>
        <tbody>
        {% for item in menu_items %}
        <tr>
          <td>{{ item['date_display'] }}</td>
          <td>{{ item['meal_type_label'] }}</td>
          <td>{{ item['title'] }}</td>
          <td>{{ item['price_display'] }}</td>
          <td>{{ item['available_qty'] }}</td>
          <td>
            <form class="inline-form" method="post" action="{{ url_for('routes.student_claim') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="menu_item_id" value="{{ item['id'] }}">
              <button type="submit">Отметить получение</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>Оплата</h3>
    <form method="post" action="{{ url_for('routes.student_pay') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <label>Тип оплаты</label>
      <select name="payment_type">
        <option value="one_time">Разовый платеж</option>
        <option value="subscription">Абонемент</option>
      </select>
      <label>Сумма</label>
      <input type="number" step="0.01" min="0.01" max="50000" name="amount" value="200" placeholder="0.01 .. 50000.00" required>
      <button type="submit">Оплатить</button>
    </form>

    <h3>История оплат</h3>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Дата</th><th>Тип</th><th>Сумма</th><th>Статус</th></tr></thead>
        <tbody>
        {% for p in payments %}
        <tr>
          <td>{{ p['created_at_display'] }}</td>
          <td>{{ p['payment_type_label'] }}</td>
          <td>{{ p['amount_display'] }}</td>
          <td>{{ p['status_label'] }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="grid grid-2">
  <div class="card">
    <h3>Отзывы о блюдах</h3>
    <form method="post" action="{{ url_for('routes.student_feedback') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <label>Блюдо</label>
      <select name="menu_item_id">
        {% for item in menu_items %}<option value="{{ item['id'] }}">{{ item['title'] }}</option>{% endfor %}
      </select>
      <label>Оценка (1-5)</label>
      <input type="number" min="1" max="5" name="rating" value="5" required>
      <label>Комментарий</label>
      <textarea name="comment" rows="3" maxlength="500" required></textarea>
      <button type="submit">Сохранить отзыв</button>
    </form>

    <div class="table-wrap">
      <table>
        <thead><tr><th>Дата</th><th>Блюдо</th><th>Оценка</th><th>Комментарий</th></tr></thead>
        <tbody>
        {% for row in feedback_list %}
        <tr>
          <td>{{ row['created_at_display'] }}</td>
          <td>{{ row['title'] }}</td>
          <td>{{ row['rating'] }}</td>
          <td>{{ row['comment'] }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>Мои отметки питания</h3>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Дата</th><th>Тип</th><th>Блюдо</th></tr></thead>
        <tbody>
        {% for c in claims %}
        <tr>
          <td>{{ c['claimed_at_display'] }}</td>
          <td>{{ c['meal_type_label'] }}</td>
          <td>{{ c['title'] }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
