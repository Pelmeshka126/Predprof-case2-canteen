# Предпроф 2025/2026 — Кейс №2 «Управление столовой»

Веб-приложение для практического тура профиля «Информационные технологии».

## Что реализовано

- Полная ролевая модель: ученик, повар, администратор.
- Публичная саморегистрация только для роли «Ученик».
- Админ-управление пользователями: смена ролей, блокировка/разблокировка.
- CSRF-защита всех POST-форм.
- Жесткая числовая валидация (`Decimal`, запрет экспоненты, `NaN`, `inf`, лимиты).
- Форматирование чисел без scientific notation.
- Legacy-нормализация заявок (`approved + unit_price=0` -> `rejected`).
- Версионные idempotent-миграции (`schema_migrations`).
- Лог аудита админ-действий (`admin_actions`).
- Админ-отчет с фильтром периода `date_from/date_to`.
- Экспорт отчета в CSV (UTF-8 BOM, `;`, период и timestamp).
- Русифицированный интерфейс и единый формат времени `DD.MM.YYYY HH:MM:SS`.
- Визуальные скриншоты 5 брейкпоинтов в `output/playwright_v3/`.

## Технологии

- Python 3.12+
- Flask 3
- SQLite
- Jinja2
- Playwright (для browser debug loop)

## Быстрый запуск

### Вариант 1 (рекомендуется)

```bash
./scripts/run_local.sh
```

### Вариант 2 (ручной)

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python3 app.py
```

Открыть в браузере: `http://127.0.0.1:5000/login`

## Переменные окружения

- `SECRET_KEY` — секрет Flask (по умолчанию `predprof-dev-secret-key`)
- `DATABASE` — путь к SQLite БД (по умолчанию `predprof_case2.db`)
- `FLASK_DEBUG` — режим debug (`0/1`, по умолчанию `0`)

## Демо-аккаунты

- Администратор: `admin@predprof.local / admin123`
- Повар: `cook@predprof.local / cook123`
- Ученик: `student@predprof.local / student123`

## План работы для всех пользователей

### Ученик

1. Зарегистрироваться (роль назначается автоматически: «Ученик»).
2. Войти в личный кабинет и просмотреть актуальное меню.
3. Выполнить оплату питания (демо-операция).
4. Отметить получение питания.
5. При необходимости обновить профиль (аллергии и предпочтения).
6. Оставить отзыв о блюде.

### Повар

1. Войти в кабинет повара.
2. Зафиксировать выдачу блюд.
3. Проверить остатки и обработать ситуацию нехватки продукта.
4. Создать заявку на закупку с корректными числовыми значениями.
5. Отслеживать статус своих заявок (ожидание/одобрено/отклонено).

### Администратор

1. Войти в админ-панель.
2. Проверить метрики за выбранный период (`date_from`/`date_to`).
3. Обработать заявки на закупку (одобрить/отклонить).
4. Управлять пользователями (`/admin/users`): роли, блокировка/разблокировка.
5. Проверить журнал админ-действий.
6. Выгрузить CSV-отчет (`/admin/report.csv`) для защиты кейса.

## Тесты

```bash
python -m unittest discover -s tests -v
```

Текущее покрытие: 32 интеграционных теста (`tests/test_case2_app.py`).

## Визуальная проверка

1. Запустить приложение.
2. Выполнить:

```bash
LD_LIBRARY_PATH="$(pwd)/.localdeps/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}" python3 scripts/visual_debug_loop.py
```

Скриншоты сохраняются в `output/playwright_v3/`.

## Структура проекта

- `app.py` — точка входа
- `app/__init__.py` — factory, CSRF, обработчик 403, env-конфиг
- `app/auth.py` — регистрация/вход/выход
- `app/routes.py` — бизнес-логика, отчеты, CSV, аудит
- `app/db.py` — схема, миграции, нормализация, seed
- `app/utils.py` — локализация ролей/статусов, форматирование дат/времени
- `app/templates/` — UI
- `scripts/run_local.sh` — стандартный локальный запуск
- `scripts/visual_debug_loop.py` — browser debug loop и скриншоты
- `tests/test_case2_app.py` — интеграционные тесты
- `docs/` — пакет документов для сдачи
- `docs/role_plan_all_users.md` — краткий план сценариев по всем ролям

## Репозиторий

- `https://github.com/Pelmeshka126/Predprof-case2-canteen`
